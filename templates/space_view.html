{% extends 'base.html' %}

{% block content %}
<!-- Add Markdown Support -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>

<style>
    /* Custom Scrollbar for Chat */
    #chat-container::-webkit-scrollbar {
        width: 8px;
    }
    #chat-container::-webkit-scrollbar-track {
        background: transparent;
    }
    #chat-container::-webkit-scrollbar-thumb {
        background-color: #4b5563;
        border-radius: 20px;
        border: 3px solid transparent;
        background-clip: content-box;
    }

    /* Markdown Styles */
    .prose p { margin-bottom: 0.75em; }
    .prose p:last-child { margin-bottom: 0; }
    .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.75em; }
    .prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 0.75em; }
    .prose code { background-color: rgba(255,255,255,0.1); padding: 0.2em 0.4em; border-radius: 0.25em; font-family: monospace; font-size: 0.9em; }
    .prose pre { background-color: #1f2937; padding: 1em; border-radius: 0.5em; overflow-x: auto; margin-bottom: 0.75em; }
    .prose pre code { background-color: transparent; padding: 0; }
    .prose h1, .prose h2, .prose h3 { color: #f3f4f6; font-weight: 600; margin-top: 1em; margin-bottom: 0.5em; }
    .prose h1 { font-size: 1.5em; }
    .prose h2 { font-size: 1.25em; }
    .prose blockquote { border-left: 4px solid #4b5563; padding-left: 1em; color: #9ca3af; font-style: italic; }
    .prose a { color: #60a5fa; text-decoration: underline; }
</style>

<div class="flex h-[calc(100vh-5rem)] gap-4">
    <!-- Sidebar -->
    <div class="w-72 bg-gray-900 border-r border-gray-800 flex flex-col hidden md:flex">
        <div class="p-4 border-b border-gray-800">
            <h2 class="text-lg font-semibold text-white truncate" title="{{ space.name }}">{{ space.name }}</h2>
            <p class="text-xs text-gray-400 mt-1 line-clamp-2">{{ space.description }}</p>
            {% if is_owner %}
            <div class="mt-4 flex gap-2">
                <a href="{% url 'manage_users' space.id %}" class="flex-1 text-center bg-gray-800 hover:bg-gray-700 text-gray-300 py-1.5 rounded text-xs transition-colors">
                    Users
                </a>
                <a href="{% url 'edit_space' space.id %}" class="flex-1 text-center bg-gray-800 hover:bg-gray-700 text-gray-300 py-1.5 rounded text-xs transition-colors">
                    Settings
                </a>
            </div>
            {% endif %}
        </div>

        {% if is_owner %}
        <!-- Tabs -->
        <div class="flex border-b border-gray-800">
            <button onclick="switchTab('upload')" id="tab-upload" class="flex-1 py-3 text-xs font-medium text-blue-400 border-b-2 border-blue-400 focus:outline-none transition-colors">Files</button>
            <button onclick="switchTab('url')" id="tab-url" class="flex-1 py-3 text-xs font-medium text-gray-500 hover:text-gray-300 focus:outline-none transition-colors">URLs</button>
        </div>

        <!-- Upload Form -->
        <div id="panel-upload" class="p-4">
            <form action="{% url 'upload_document' space.id %}" method="post" enctype="multipart/form-data" class="space-y-3" onsubmit="showProgress()">
                {% csrf_token %}
                <div class="border-2 border-dashed border-gray-700 rounded-lg p-4 text-center hover:border-gray-500 transition-colors group cursor-pointer relative">
                    <input type="file" name="files" multiple accept=".pdf,.txt,.md,.csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" id="file-upload" onchange="updateFileName(this)">
                    <div class="space-y-1">
                        <svg class="mx-auto h-8 w-8 text-gray-500 group-hover:text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <p class="text-xs text-gray-400">Drop files here (max 10)</p>
                    </div>
                </div>
                <p id="file-name" class="text-xs text-gray-500 truncate min-h-[1rem]"></p>
                <button type="submit" id="upload-btn" disabled class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded text-sm font-medium transition-colors shadow-lg shadow-blue-900/20 disabled:opacity-50 disabled:cursor-not-allowed">
                    Upload
                </button>
            </form>
        </div>

        <!-- URL Ingest Form -->
        <div id="panel-url" class="p-4 hidden">
            <form action="{% url 'ingest_url' space.id %}" method="post" class="space-y-3" onsubmit="showProgress()">
                {% csrf_token %}
                <div>
                    <textarea name="urls" id="url-input" placeholder="https://example.com/article1&#10;https://example.com/article2&#10;(One URL per line, max 10)" 
                           class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 placeholder-gray-600 resize-none h-32"
                           oninput="updateFetchBtn(this)"></textarea>
                </div>
                <button type="submit" id="fetch-btn" disabled class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded text-sm font-medium transition-colors shadow-lg shadow-blue-900/20 disabled:opacity-50 disabled:cursor-not-allowed">
                    Fetch URLs
                </button>
            </form>
        </div>

        <!-- Progress Indicator -->
        <div id="progress-indicator" class="hidden px-4 pb-4">
            <div class="bg-gray-800 rounded p-3 flex items-center space-x-3 border border-gray-700">
                <div class="animate-spin rounded-full h-4 w-4 border-2 border-blue-500 border-t-transparent"></div>
                <span class="text-xs text-gray-300">Processing...</span>
            </div>
        </div>
        {% endif %}

        <!-- Document List -->
        <div class="flex-1 overflow-y-auto px-2 py-2 border-t border-gray-800">
            <h3 class="px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Documents</h3>
            <div class="space-y-0.5">
                {% for doc in space.documents.all %}
                <div class="flex items-center justify-between group px-2 py-1.5 rounded hover:bg-gray-800 transition-colors">
                    <div class="flex items-center min-w-0 gap-2">
                        <svg class="w-4 h-4 text-gray-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        {% if doc.file %}
                        <a href="{{ doc.file.url }}" target="_blank" class="text-sm text-gray-400 truncate group-hover:text-blue-400 transition-colors hover:underline" title="{{ doc.title }}">{{ doc.title }}</a>
                        {% else %}
                        <span class="text-sm text-gray-400 truncate cursor-default" title="{{ doc.title }} (File missing)">{{ doc.title }}</span>
                        {% endif %}
                    </div>
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        {% if doc.summary %}
                        <button onclick="showSummary('{{ doc.title|escapejs }}', '{{ doc.summary|escapejs }}')" class="text-gray-600 hover:text-blue-400 p-1" title="View Summary">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </button>
                        {% endif %}
                        {% if is_owner %}
                        <a href="{% url 'delete_document' space.id doc.id %}" class="text-gray-600 hover:text-red-400 p-1" onclick="return confirm('Delete this document?')">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <p class="text-xs text-gray-600 italic text-center py-4">No documents</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col relative bg-gray-900 rounded-xl overflow-hidden shadow-2xl border border-gray-800">
        <!-- Chat History -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 pb-48 space-y-6 scroll-smooth min-h-0">
            <!-- Intro Message -->
            <div class="flex gap-4 max-w-3xl mx-auto w-full group">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center flex-shrink-0 shadow-lg shadow-purple-900/20 mt-1">
                    <!-- <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg> -->
                     AI
                </div>
                <div class="flex-1 space-y-2">
                    <div class="prose prose-invert max-w-none text-gray-300 text-sm leading-relaxed">
                        <p>Hello! I'm ready to help you analyze your documents. Ask me anything about the content you've uploaded.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Floating Input Area -->
        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-gray-900 via-gray-900 to-transparent pt-12 pb-6 px-4">
            <div class="max-w-3xl mx-auto w-full">
                <!-- Input Container -->
                <div class="bg-gray-800 rounded-2xl border border-gray-700 shadow-xl flex flex-col transition-all duration-200 focus-within:border-gray-600 focus-within:bg-gray-800/80 focus-within:ring-1 focus-within:ring-gray-600">
                    <form id="chat-form" method="POST" class="relative flex items-end p-2 gap-2">
                        {% csrf_token %}
                        
                        <!-- Textarea -->
                        <textarea id="chat-input" name="message" rows="1" 
                            class="w-full bg-transparent text-gray-200 placeholder-gray-500 px-4 py-3 focus:outline-none resize-none max-h-48 overflow-y-auto text-base"
                            placeholder="Ask a question..." required></textarea>
                        
                        <!-- Send Button -->
                        <button type="submit" id="send-button" class="p-2.5 rounded-full bg-white text-gray-900 hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed mb-0.5 shadow-lg">
                            <svg class="w-5 h-5 transform rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                        </button>
                        
                        <!-- Cancel Button (Hidden) -->
                        <button type="button" id="cancel-button" class="hidden p-2.5 rounded-full bg-red-500 text-white hover:bg-red-600 transition-colors mb-0.5 shadow-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </form>
                    
                    <!-- Footer/Context Info -->
                    <div class="px-4 pb-2.5 flex justify-between items-center border-t border-gray-700/50 pt-2 mt-1">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <select name="document_id" form="chat-form" class="bg-gray-800 text-xs text-gray-300 hover:text-white cursor-pointer focus:outline-none border border-gray-700 rounded px-2 py-1 transition-colors">
                                <option value="all" class="bg-gray-800">All Documents</option>
                                {% for doc in space.documents.all %}
                                    <option value="{{ doc.id }}" class="bg-gray-800">{{ doc.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="text-[10px] text-gray-600 uppercase tracking-wider font-medium">GraphRAG</div>
                    </div>
                </div>
                <div class="text-center text-[10px] text-gray-600 mt-3 font-medium">
                    AI can make mistakes. Please verify important information.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Tabs Logic ---
    function switchTab(tab) {
        const tabUpload = document.getElementById('tab-upload');
        const tabUrl = document.getElementById('tab-url');
        const panelUpload = document.getElementById('panel-upload');
        const panelUrl = document.getElementById('panel-url');

        if (tab === 'upload') {
            tabUpload.classList.add('text-blue-400', 'border-blue-400');
            tabUpload.classList.remove('text-gray-500');
            tabUrl.classList.remove('text-blue-400', 'border-blue-400');
            tabUrl.classList.add('text-gray-500');
            panelUpload.classList.remove('hidden');
            panelUrl.classList.add('hidden');
        } else {
            tabUrl.classList.add('text-blue-400', 'border-blue-400');
            tabUrl.classList.remove('text-gray-500');
            tabUpload.classList.remove('text-blue-400', 'border-blue-400');
            tabUpload.classList.add('text-gray-500');
            panelUrl.classList.remove('hidden');
            panelUpload.classList.add('hidden');
        }
    }

    function updateFileName(input) {
        const fileName = document.getElementById('file-name');
        const uploadBtn = document.getElementById('upload-btn');
        
        if (input.files.length > 0) {
            const count = input.files.length;
            if (count > 10) {
                fileName.textContent = `Too many files! Maximum 10 allowed (selected: ${count})`;
                fileName.classList.add('text-red-400');
                uploadBtn.disabled = true;
            } else {
                fileName.textContent = `${count} file(s) selected`;
                fileName.classList.remove('text-red-400');
                uploadBtn.disabled = false;
            }
        } else {
            fileName.textContent = '';
            fileName.classList.remove('text-red-400');
            uploadBtn.disabled = true;
        }
    }

    function updateFetchBtn(input) {
        const fetchBtn = document.getElementById('fetch-btn');
        const lines = input.value.trim().split('\n').filter(l => l.trim().length > 0);
        
        if (lines.length > 0 && lines.length <= 10) {
            fetchBtn.disabled = false;
        } else {
            fetchBtn.disabled = true;
        }
    }

    const progressIndicator = document.getElementById('progress-indicator');
    function showProgress() { if (progressIndicator) progressIndicator.classList.remove('hidden'); }
    function hideProgress() { if (progressIndicator) progressIndicator.classList.add('hidden'); }

    // --- Chat Logic ---
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Chat script loaded');
        
        let currentAbortController = null;
        const chatInput = document.getElementById('chat-input');
        const chatForm = document.getElementById('chat-form');
        
        if (!chatInput || !chatForm) {
            console.error('Chat elements not found!');
            return;
        }

        // History Navigation
        let chatHistory = [];
    let historyIndex = -1;
    let currentDraft = '';

    // Auto-resize textarea
    chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        if (this.value === '') this.style.height = 'auto';
    });

    // Keyboard Handling
    chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (this.value.trim()) {
                if (chatForm.requestSubmit) {
                    chatForm.requestSubmit();
                } else {
                    chatForm.dispatchEvent(new Event('submit', {cancelable: true}));
                }
            }
        } else if (e.key === 'ArrowUp') {
            if (historyIndex === -1 && this.value) currentDraft = this.value;
            if (historyIndex < chatHistory.length - 1) {
                historyIndex++;
                this.value = chatHistory[chatHistory.length - 1 - historyIndex];
                setTimeout(() => this.setSelectionRange(this.value.length, this.value.length), 0);
            }
            e.preventDefault();
        } else if (e.key === 'ArrowDown') {
            if (historyIndex > -1) {
                historyIndex--;
                if (historyIndex === -1) {
                    this.value = currentDraft;
                    currentDraft = '';
                } else {
                    this.value = chatHistory[chatHistory.length - 1 - historyIndex];
                }
                setTimeout(() => this.setSelectionRange(this.value.length, this.value.length), 0);
            }
            e.preventDefault();
        }
    });

    // Form Submission
    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (!message) return;

        // Create FormData BEFORE clearing the input
        const formData = new FormData(this);
        
        // Manually ensure document_id is included (safeguard for form attribute support)
        const docSelect = document.querySelector('select[name="document_id"]');
        if (docSelect && !formData.has('document_id')) {
            formData.append('document_id', docSelect.value);
        }
        
        // Debug logging
        console.log('Sending message:', message, 'Doc ID:', formData.get('document_id'));

        // Add to history
        chatHistory.push(message);
        historyIndex = -1;
        currentDraft = '';

        // Display user message
        appendMessage('user', message);
        
        // NOW clear the input
        chatInput.value = '';
        chatInput.style.height = 'auto';

        // Disable input
        chatInput.disabled = true;
        document.getElementById('send-button').classList.add('hidden');
        document.getElementById('cancel-button').classList.remove('hidden');

        // Create abort controller
        currentAbortController = new AbortController();

        // Create assistant message with thinking indicator
        let assistantDiv = appendMessage('assistant', '');
        let buffer = '';
        let isFirstChunk = true;

        try {
            const response = await fetch("{% url 'chat_api' space.id %}", {
                method: 'POST',
                body: formData,
                signal: currentAbortController.signal
            });

            if (!response.ok) throw new Error('Network error');

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            while (true) {
                const {done, value} = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value, {stream: true});
                
                // Replace thinking indicator with actual content on first chunk
                if (isFirstChunk && chunk.trim()) {
                    isFirstChunk = false;
                }
                
                buffer += chunk;
                assistantDiv.innerHTML = DOMPurify.sanitize(marked.parse(buffer));
                scrollToBottom();
            }
        } catch (err) {
            if (err.name !== 'AbortError') {
                appendMessage('assistant', 'Sorry, an error occurred. Please try again.');
            }
        } finally {
            chatInput.disabled = false;
            document.getElementById('send-button').classList.remove('hidden');
            document.getElementById('cancel-button').classList.add('hidden');
            currentAbortController = null;
            chatInput.focus();
        }
    });

    // Cancel button
    document.getElementById('cancel-button').addEventListener('click', function() {
        if (currentAbortController) {
            currentAbortController.abort();
        }
    });

    function appendMessage(role, content) {
        const container = document.getElementById('chat-container');
        const messageDiv = document.createElement('div');
        let aiContentId = null;
        
        if (role === 'user') {
            // User message - right aligned
            messageDiv.className = 'flex justify-end mb-6';
            messageDiv.innerHTML = `
                <div class="bg-blue-600 text-white px-5 py-3 rounded-2xl rounded-tr-sm max-w-[80%] shadow-md">
                    <div class="prose prose-invert text-sm leading-relaxed">${DOMPurify.sanitize(content.replace(/\n/g, '<br>'))}</div>
                </div>
            `;
        } else {
            // Assistant message - left aligned with AI icon
            messageDiv.className = 'flex gap-4 max-w-3xl mx-auto w-full group mb-6';
            aiContentId = 'ai-msg-' + Date.now();
            
            messageDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center flex-shrink-0 shadow-lg shadow-purple-900/20 mt-1">
                    AI
                </div>
                <div class="flex-1 space-y-2">
                    <div class="prose prose-invert max-w-none text-gray-300 text-sm leading-relaxed" id="${aiContentId}">
                        ${content ? DOMPurify.sanitize(marked.parse(content)) : '<div class="flex items-center gap-2 text-gray-500"><svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Thinking...</span></div>'}
                    </div>
                </div>
            `;
        }

        container.appendChild(messageDiv);
        scrollToBottom();
        
        if (role === 'assistant' && aiContentId) {
            return document.getElementById(aiContentId);
        }
        return null;
    }

    function scrollToBottom() {
        const container = document.getElementById('chat-container');
        container.scrollTop = container.scrollHeight;
    }
    });

    // Summary Modal Logic
    function showSummary(title, summary) {
        const modal = document.getElementById('summary-modal');
        const modalTitle = document.getElementById('summary-modal-title');
        const modalContent = document.getElementById('summary-modal-content');
        
        modalTitle.textContent = title;
        modalContent.innerHTML = DOMPurify.sanitize(marked.parse(summary));
        modal.classList.remove('hidden');
    }

    function closeSummary() {
        document.getElementById('summary-modal').classList.add('hidden');
    }
</script>

<!-- Summary Modal -->
<div id="summary-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="if(event.target === this) closeSummary()">
    <div class="bg-gray-800 rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] flex flex-col border border-gray-700">
        <div class="flex justify-between items-center p-4 border-b border-gray-700">
            <h3 id="summary-modal-title" class="text-lg font-semibold text-white truncate pr-4">Document Summary</h3>
            <button onclick="closeSummary()" class="text-gray-400 hover:text-white transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div id="summary-modal-content" class="p-6 overflow-y-auto prose prose-invert max-w-none text-sm leading-relaxed">
            <!-- Content injected via JS -->
        </div>
        <div class="p-4 border-t border-gray-700 flex justify-end">
            <button onclick="closeSummary()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm font-medium transition-colors">
                Close
            </button>
        </div>
    </div>
</div>
{% endblock %}
